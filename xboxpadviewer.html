<!DOCTYPE html>
<html lang="en">

	<head>
		<meta content="text/html;charset=utf-8" http-equiv="content-type">
		<meta content="utf-8" http-equiv="encoding">
		<meta name="viewport"
					content="width=device-width, initial-scale=1.0" />
		<title></title>
		<!--<link rel="shortcut icon" href="/favicon.ico">
		<link rel="apple-touch-icon"
					href="./appiconios.png" />
		<link rel="apple-touch-icon-precomposed"
					href="./appiconandroid.png" />
		<link rel="stylesheet" href="./your.css">-->
		<link href="mapping.css" rel="stylesheet">
		<style>
			
		</style>
	</head>
	
	<!--<script src="./your.js"></script>-->
	<script>
		window.onload = function() {
			document.body.style.fontSize = "16px";
		};

		var gpConstants = {
			thumbSize: 60
			,pressedButtonColor: "orange"
			,axisSensitivity: 2
		};

		function cl(...t) {
			console.log(...t);
		};

		// for the 'in' keyword: I used the code below as a reference.
		// https://github.com/luser/gamepadtest/blob/master/gamepadtest.js
		var haveEvents = 'GamepadEvent' in window;
		var haveWebkitEvents = 'WebKitGamepadEvent' in window;
		var rAF = window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.requestAnimationFrame;

		var gamepads = {};
		var gamepadTimestamps = {};
		function gamepadTimestamp() {
			var buttons = [];
			var axes = {};

			this.buttonAdd = function() { buttons.push({t:0,v:0}); }
			this.axisAdd = function(n) { axes[n] = {t:0,v:0}; }

			this.age = function() {
				for(var i=0; i<buttons.length; i++) {
					buttons[i].t++;
				}
				for(a in axes) {
					axes[a].t++;
				}
			};
			this.buttonUpdate = function(n,v) {
				if(buttons[n].v !== v) {
					buttons[n].t = 0;
					buttons[n].v = v;
				}
			};
			this.axisUpdate = function(n,v) {
				if(axes[n].v !== v) {
					axes[n].t = 0; 
					axes[n].v = v;
				}
			};

			this.showAll = function() {
				var txt = "";
				for(var i=0;i<buttons.length;i++) { txt+= `${buttons[i].t}${buttons[i].v} `; }
				cl(txt); txt="";
				for(a in axes) { txt+= `${a}:${axes[a].t}${axes[a].v} `; }
				cl(txt);
			}
		};

		var gamepadHandler = {
			connect: function(e) {
				gamepads[e.index] = e;
				cl("connected: %d", e.index);
				gamepadDOMs.add(e);
			},
			disconnect: function(index) {
				cl("disconnecting: %d", index);
				gamepadDOMs.remove(index);
				delete gamepads[index];
			},
			scan: function() {
				var gamepadsFromNavigator = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
				for(var i=0; i<gamepadsFromNavigator.length; i++) {
					if(gamepadsFromNavigator[i]) {
						if(gamepadsFromNavigator[i].index in gamepads) {
							gamepads[gamepadsFromNavigator[i].index] = gamepadsFromNavigator[i];
						} else {
							gamepadHandler.connect(gamepadsFromNavigator[i]);
						}
					} else if(gamepadsFromNavigator[i] === null
					&& document.getElementById(`gp${i}`)) {
						gamepadHandler.disconnect(i);
					}
				}
			}
		};

		var gamepadMapping = {
			"Microsoft Controller (Vendor: 045e Product: 02d1)": {
				buttons: [
					{name:"A", type:"button"}
					,{name:"B", type:"button"}
					,{name:"X", type:"button"}
					,{name:"Y", type:"button"}
					,{name:"LB", type:"button"}
					,{name:"RB", type:"button"}
					,{name:"Se", type:"button"}
					,{name:"St", type:"button"}
					,{name:"â“§", type:"button"}
					,{name:"L", type:"button thumb"}
					,{name:"R", type:"button thumb"}
				]
				,axes: [
					{name:"L", type:"thumb"}
					,{name:"L", type:"thumb"}
					,{name:"LT", type:"button"}
					,{name:"R", type:"thumb"}
					,{name:"R", type:"thumb"}
					,{name:"RT", type:"button"}
					,{name:"D", type:"button"}
					,{name:"D", type:"button"}
				]
			}
			,"Xbox 360 Controller (XInput STANDARD GAMEPAD)": {
				buttons: [
					{name:"A", type:"button"}
					,{name:"B", type:"button"}
					,{name:"X", type:"button"}
					,{name:"Y", type:"button"}
					,{name:"LB", type:"button"}
					,{name:"RB", type:"button"}
					,{name:"LT", type:"button"}
					,{name:"RT", type:"button"}
					,{name:"Se", type:"button"}
					,{name:"St", type:"button"}
					,{name:"L", type:"button thumb"}
					,{name:"R", type:"button thumb"}
					,{name:"U", type:"button"}
					,{name:"D", type:"button"}
					,{name:"L", type:"button"}
					,{name:"R", type:"button"}
				]
				,axes: [
					{name:"L", type:"thumb"}
					,{name:"L", type:"thumb"}
					,{name:"R", type:"thumb"}
					,{name:"R", type:"thumb"}
				]
			}
		};

		var gamepadDOMs = {
			add: function(gp) {
				// create a couple of arrays for tracking button's timestamp
				gamepadTimestamps[gp.index] = new gamepadTimestamp();
				// create dom for a gamepad
				var d = document.createElement("div");
				d.setAttribute("id",`gp${gp.index}`);
				d.setAttribute("class",gp.id);
				// create dom for buttons
				var b = document.createElement("div");
				b.setAttribute("class","buttons");
				for(var i=0; i<gp.buttons.length; i++) {
					if(gamepadMapping[gp.id]) {
						var cur = gamepadMapping[gp.id].buttons[i];
						var e = document.createElement("span");
						if(cur.type === "button thumb") {
						} else {
							e.setAttribute("class",cur.type);
							e.innerHTML = `${cur.name}`;
						}
					} else {
						var e = document.createElement("span");
						e.setAttribute("class","button");
						e.innerHTML = i;
					}
					b.appendChild(e);
					gamepadTimestamps[gp.index].buttonAdd();
				}
				d.appendChild(b);
				// create dom for axes
				var a = document.createElement("div");
				a.setAttribute("class","axes");
				var c; // c resides in e and represent the position of thumb stick.
				for(i=0; i<gp.axes.length; i++) {
					if(gamepadMapping[gp.id]) {
						var cur = gamepadMapping[gp.id].axes[i];
						if(a.getElementsByClassName(`axis ${cur.name}`).length) {
							c.style.top = `${gpConstants.thumbSize/2}%`;
						} else {
							e = document.createElement("span");
							e.setAttribute("class",`axis ${cur.name}`);
							c = document.createElement("span");
							c.style.width = `${gpConstants.thumbSize}%`;
							c.style.height = `${gpConstants.thumbSize}%`;
							c.style.left = `${gpConstants.thumbSize/2}%`;
							e.appendChild(c);
							a.appendChild(e);
							gamepadTimestamps[gp.index].axisAdd(cur.name);
						}
					} else {
						e = document.createElement("span");
						e.setAttribute("class","axis");
						e.innerHTML = `${i} `;
						a.appendChild(e);
					}
				}
				d.appendChild(a);
				// attach gamepad dom to the document
				document.body.appendChild(d);
				rAF(gamepadDOMs.update);
			},
			remove: function(index) {
				var d = document.getElementById(`gp${index}`);
				document.body.removeChild(d);
				delete gamepadTimestamps[gp.index];
			},
			update: function() {
				gamepadHandler.scan();
				for(j in gamepads) {
					var gp = gamepads[j];
					gamepadTimestamps[gp.index].age();
					var d = document.getElementById(`gp${gp.index}`);

					var b = d.getElementsByClassName("buttons")[0];
					for(var i=0; i<gp.buttons.length; i++) {
						var cur = gamepadMapping[gp.id].buttons[i];
						var e;
						var es = gp.buttons[i]; // each status of buttons
						var val = 100*es.value;
						if(cur.type === "button thumb") {
							e = d.getElementsByClassName(`axis ${cur.name}`)[0].children[0];
							if(val===100) {
								e.style.background = "url(dot.png)";
							} else {
								e.style.background = "white";
							}
							gamepadTimestamps[gp.index].buttonUpdate(i, val);
						} else {
							e = b.children[i]; // each dom for buttons
							e.style.backgroundSize = `100% ${val}%`;
							if(val) {
								e.style.color = gpConstants.pressedButtonColor;
							} else {
								e.style.color = "white";
							}
							gamepadTimestamps[gp.index].buttonUpdate(i, val);
						}
					}
					
					var a;
					for(i=0; i<gp.axes.length; i++) {
						if(gamepadMapping[gp.id]) {
							var cur = gamepadMapping[gp.id].axes[i];
							if(cur.type === "thumb") {
								a = d.getElementsByClassName(`axis ${cur.name}`)[0].children[0];
								var thumbMargin = (100-gpConstants.thumbSize)/2;
								if(i%2) {
									a.style.top = `${thumbMargin+thumbMargin*gp.axes[i]}%`;
								} else {
									a.style.left = `${thumbMargin+thumbMargin*gp.axes[i]}%`;
								}
								var val = 
								Math.pow(10,2*gpConstants.axisSensitivity)
								*parseFloat(a.style.left).toFixed(gpConstants.axisSensitivity-1)
								+Math.pow(10,gpConstants.axisSensitivity-1)
								*parseFloat(a.style.top).toFixed(gpConstants.axisSensitivity-1);
								gamepadTimestamps[gp.index].axisUpdate(cur.name,val);
							}
						} else {
							var a = d.getElementsByClassName("axis");
							e = a[i];
							e.innerHTML = `${i}${gp.axes[i].toFixed(4)} `;
						}
					}

				}
				rAF(gamepadDOMs.update);
			}
		};

		rAF(gamepadDOMs.update);
		if(haveEvents) {
				window.addEventListener("gamepadconnected", function(e) {
					gamepadHandler.connect(e.gamepad);
				});
			//window.addEventListener("gamepadconnected", gamepadHandler.scan);
			window.addEventListener("gamepaddisconnected", function(e) {
				gamepadHandler.disconnect(e.gamepad);
			});
		} else if(haveWebkitEvents) {
				window.addEventListener("webkitgamepadconnected", function(e) {
					gamepadHandler.connect(e.gamepad);
				});
			//window.addEventListener("webkitgamepadconnected", gamepadHandler.scan);
			window.addEventListener("webkitgamepaddisconnected", function(e) {
				gamepadHandler.disconnect(e.gamepad);
			});
		} else {
			var scanningWithNoEvents = setInterval(gamepadHandler.scan, 500);
		}
	</script>
	
	<body>
	</body>
	
</html>
